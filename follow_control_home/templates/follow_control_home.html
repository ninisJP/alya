{% extends 'follow_control_base.html' %}

{% block content %}
<div class="container-fluid py-4">
    <h2 class="text-primary fw-bold">Calendario de Tarjetas</h2>

    <!-- Contenedor del Calendario -->
    <div id="calendar" class="calendar-container shadow-lg rounded mb-4"></div>

    <!-- Modal para mostrar detalles de las tarjetas -->
    <div class="modal fade" id="cardDetailsModal" tabindex="-1" aria-labelledby="cardDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="cardDetailsModalLabel">Detalles de la Tarjeta</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <table class="table table-hover m-0">
                        <thead class="table-dark">
                            <tr>
                                <th>Descripción</th>
                                <th>Valor</th>
                                <th>Fecha</th>
                            </tr>
                        </thead>
                        <tbody id="modalBodyContent">
                            <!-- Los detalles de las tarjetas se cargarán aquí -->
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Incluye FullCalendar y Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const calendarEl = document.getElementById('calendar');
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'es',
                themeSystem: 'bootstrap5',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: [
                    {% for date, cards in cards_by_date.items %}
                    {
                        title: "{{ cards|length }} Tarjeta(s)",
                        start: "{{ date }}",
                        extendedProps: {
                            cards: [
                                {% for card in cards %}
                                {
                                    description: "{{ card.description }}",
                                    value: "{{ card.valuation }}",
                                    date: "{{ card.date|date:'Y-m-d' }}"
                                },
                                {% endfor %}
                            ]
                        }
                    },
                    {% endfor %}
                ],
                eventClick: function(info) {
                    const cards = info.event.extendedProps.cards;
                    const cardRows = cards.map(card => `
                        <tr>
                            <td>${card.description}</td>
                            <td>${card.value}</td>
                            <td>${card.date}</td>
                        </tr>
                    `).join('');

                    document.getElementById('modalBodyContent').innerHTML = cardRows;
                    const cardModal = new bootstrap.Modal(document.getElementById('cardDetailsModal'));
                    cardModal.show();
                }
            });
            calendar.render();
        });
    </script>
</div>
{% endblock %}
